#
# start swarm-registrator
# start consul template
# start haproxy
#

swarmregistrator:
  environment:
    - DOCKER_HOST=tcp://192.168.200.1:2378
  image: hypriot/rpi-registrator
  command: -internal consul://192.168.200.1:8500

consultemplate:
  image: hypriot/rpi-consul-template
  restart: always
  volumes:
    - ./docker_arm:/usr/bin/docker
    - /var/run/docker.sock:/var/run/docker.sock
    - ./haproxy/:/haproxy/
#    - ./consul-template_restarts_haproxy.sh:/consul-template_restarts_haproxy.sh
  environment:
    - HAPROXYNAME=loadbalancingwithhaproxy_haproxy_1
    - CONSULIP=192.168.200.1
    - SWARMIP=192.168.200.1
  command: -consul 192.168.200.1:8500 -template "/haproxy/haproxy.ctmpl:/haproxy/haproxy.cfg:docker exec loadbalancingwithhaproxy_haproxy_1 /haproxy-start reload"
#/consul-template_restarts_haproxy.sh"
#docker exec cluster_haproxy_1 /haproxy-start reload"


haproxy:
  image: hypriot/rpi-haproxy:1.5.8
  restart: always
  ports:
    - "0.0.0.0:80:80"
    - "0.0.0.0:443:443"
  volumes:
    - ./haproxy/:/haproxy-override/
#  command: haproxy -f /haproxy-override/haproxy.cfg -p /var/run/haproxy.pid
