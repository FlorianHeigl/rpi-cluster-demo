#
# start swarm-registrator
# start consul template
# start haproxy
#

swarmregistrator:
  environment:
    - DOCKER_HOST=tcp://192.168.200.1:2378
  image: hypriot/rpi-registrator:master
  command: -internal consul://192.168.200.1:8500

consultemplate:
  image: hypriot/rpi-consul-template
  restart: always
  volumes:
    - /var/run/docker.sock:/var/run/docker.sock
    - ./haproxy/:/haproxy/
  command: -consul 192.168.200.1:8500 -template "/haproxy/haproxy.ctmpl:/haproxy/haproxy.cfg:docker exec infrastructure_haproxy_1 /haproxy-start reload"

haproxy:
  image: hypriot/rpi-haproxy:1.5.8
  restart: always
  ports:
    - "0.0.0.0:80:80"
    - "0.0.0.0:443:443"
  volumes:
    - ./haproxy/:/haproxy-override/

